syntax = "proto3";

package api.review.v1;

option go_package = "review-service/api/review/v1;v1";
option java_multiple_files = true;
option java_package = "api.review.v1";

import "google/api/annotations.proto";

// Review entity
message ReviewRecord {
  uint64 id = 1;
  uint64 user_id = 2;
  string subject = 3;
  string content = 4;
  int32 rating = 5;
  int64 created_at = 6; // unix seconds
  string status = 7; // PENDING|APPROVED|REJECTED
  string audit_reason = 8;
  uint64 audit_by = 9;
  int64 audit_at = 10;
}

service Review {
    rpc CreateReview (CreateReviewRequest) returns (CreateReviewReply) {
        option (google.api.http) = {
            post: "/v1/reviews"
            body: "*"
        };
    };
    rpc UpdateReview (UpdateReviewRequest) returns (UpdateReviewReply) {
        option (google.api.http) = {
            put: "/v1/reviews/{id}"
            body: "*"
        };
    };
    rpc DeleteReview (DeleteReviewRequest) returns (DeleteReviewReply) {
        option (google.api.http) = {
            delete: "/v1/reviews/{id}"
        };
    };
    rpc GetReview (GetReviewRequest) returns (GetReviewReply) {
        option (google.api.http) = {
            get: "/v1/reviews/{id}"
        };
    };
    rpc ListReview (ListReviewRequest) returns (ListReviewReply) {
        option (google.api.http) = {
            get: "/v1/reviews"
        };
    };

    // O: 审核评价
    rpc AuditReview (AuditReviewRequest) returns (AuditReviewReply) {
        option (google.api.http) = {
            post: "/v1/reviews/{id}:audit"
            body: "*"
        };
    };

    // B: 商家回复评价
    rpc CreateReply (CreateReplyRequest) returns (CreateReplyReply) {
        option (google.api.http) = {
            post: "/v1/reviews/{id}:reply"
            body: "*"
        };
    };

    // B/C: 查看评价回复列表
    rpc ListReplies (ListRepliesRequest) returns (ListRepliesReply) {
        option (google.api.http) = {
            get: "/v1/reviews/{id}/replies"
        };
    };

    // O: 待审核列表
    rpc ListPendingReview (ListPendingReviewRequest) returns (ListPendingReviewReply) {
        option (google.api.http) = {
            get: "/v1/reviews:pending"
        };
    };
}

message CreateReviewRequest {
  uint64 user_id = 1;
  string subject = 2;
  string content = 3;
  int32 rating = 4;
}
message CreateReviewReply {
  uint64 id = 1;
}

message UpdateReviewRequest {
  uint64 id = 1;
  string subject = 2;
  string content = 3;
  int32 rating = 4;
}
message UpdateReviewReply {}

message DeleteReviewRequest {
  uint64 id = 1;
}
message DeleteReviewReply {}

message GetReviewRequest {
  uint64 id = 1;
}
message GetReviewReply {
  ReviewRecord review = 1;
}

message ListReviewRequest {
  int32 page = 1;
  int32 page_size = 2;
  // 关键字搜索（匹配 subject、content，多字段相关性检索）
  string q = 3;
  // 过滤：指定用户的评价
  uint64 user_id = 4;
  // 过滤：评分范围
  int32 rating_min = 5;
  int32 rating_max = 6;
  // 排序字段："relevance"|"ts"|"rating"（默认：relevance）
  string sort = 7;
  // 排序方向："asc"|"desc"（默认：desc）
  string order = 8;
}
message ListReviewReply {
  int64 total = 1;
  repeated ReviewRecord reviews = 2;
}

message AuditReviewRequest {
  uint64 id = 1;
  string decision = 2; // APPROVE|REJECT
  string reason = 3;
  uint64 operator_id = 4;
}
message AuditReviewReply {}

message CreateReplyRequest {
  uint64 id = 1; // review id
  uint64 merchant_id = 2;
  string content = 3;
}
message CreateReplyReply {}

message ListRepliesRequest {
  uint64 id = 1; // review id
}
message ReplyRecord {
  uint64 id = 1;
  uint64 review_id = 2;
  uint64 merchant_id = 3;
  string content = 4;
  int64 created_at = 5;
}
message ListRepliesReply {
  repeated ReplyRecord replies = 1;
}

message ListPendingReviewRequest {
  int32 page = 1;
  int32 page_size = 2;
}
message ListPendingReviewReply {
  int64 total = 1;
  repeated ReviewRecord reviews = 2;
}
